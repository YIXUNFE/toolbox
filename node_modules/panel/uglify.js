'use strict'

var $ = require('jquery'),
  actionBtn = require('common/actionBtn'),
  ipc = require('electron').ipcRenderer

var panel = (function () {
  
  function _render (html, data, channelInfo) {
    $('#box').append(html)
    
    actionBtn.extend('uglify-it', _uglifyIt)
    actionBtn.extend('copy-it', _copyIt)
    
    var box = $('.uglify-box'),
      jsHandler = require('uglify-js'),
      cssHandler = require('uglifycss'),
      contextBox
    
    function _uglifyIt () {
      var currentCate = $('[name="cate"]:checked', box).val(),
        textarea = $('#uglify-context'),
        content = textarea.val(),
        result = ''
      if (currentCate === 'css') {
        textarea.val(cssHandler.processString(content))
      } else {
        result = jsHandler.minify(content, {fromString: true}).code
        textarea.val(result)
      }
    }
    
    $('#uglify-context').on('change', function () {
      var o = $(this),
        btn = $('.copy-it')
      if (this.value === '') {
        btn.addClass('disabled')
      } else {
        btn.removeClass('disabled')
      }
    })
    
    function _copyIt () {
      var textarea = $('#uglify-context'),
        str = textarea.val()
      if (str !== '') {
        ipc.send('copy-text', str)
      }
    }
    
  }
  
  return {
    tpl: '<div class="uglify-box">\
      <div class="select-box">\
        <label><input type="radio" name="cate" value="js" checked /> 压缩 JS </label>\
        <label><input type="radio" name="cate" value="css" /> 压缩 CSS </label>\
      </div>\
      <textarea placeholder="请输入需要压缩的内容" id="uglify-context" class="context"></textarea>\
      <div class="btn-box">\
        <button action="uglify-it" class="action uglify-it">压缩</button>\
        <button action="copy-it" class="action copy-it disabled" >复制</button>\
      </div>\
    </div>',
    render: _render
  }
}())

module.exports = panel