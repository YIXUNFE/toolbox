var http = require('http'),
    httpProxy = require('http-proxy')

//
// Create a proxy server with latency
//
var proxy = httpProxy.createProxyServer({})

proxy.on('error', function (err, req, res) {
  //console.log(err)
  res.writeHead(500, {
    'Content-Type': 'text/plain'
  });

  res.end('Something went wrong. \r\nPlease insure website which can be avaliable in your network.\r\n' + err);
});

//
// Create your server that makes an operation that waits a while
// and then proxies the request
//
var proxyServer = http.createServer(function (req, res) {
  // This simulates an operation that takes 500ms to execute
  var host = req.headers.host
  try {
    proxy.web(req, res, {target: 'http://' + host})
  } catch (e) {
    console.log(e)
  }
})

proxyServer.on('upgrade', function (req, socket, head) {
  var host = req.headers.host
  try {
    proxy.ws(req, socket, head, {target: 'http://' + host})
  } catch (e) {
    console.log(e)
  }
})

var arguments = process.argv.splice(2),
  port = arguments[0] || '9999'
console.log('proxy on, listen @ ' + port)
proxyServer.listen(port)




